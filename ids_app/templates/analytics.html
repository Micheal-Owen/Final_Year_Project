{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- Begin Page Content -->
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h3 class="h3 mb-0 text-gray-800">IDS Analytics</h3>
    </div>
    
    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" class="form-control">
        </div>
        <div class="col-md-6">
            <label for="end_date">End Date:</label>
            <input type="date" id="end_date" class="form-control">
        </div>
    </div>


    <!-- Content Row -->
    <div class="row">
        <!-- Real-Time Network Traffic Chart -->
        <div class="col-xl-12 col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Real-Time Network Traffic</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="networkTrafficChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Top Talkers Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Top Talkers</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="topTalkersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Listeners Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Top Listeners</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="topListenersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Attack Trends Over Time Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Attack Trends Over Time</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="attackTrendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Protocol Usage Distribution Chart -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Protocol Usage Distribution</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="protocolUsageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Attack Severity Over Time Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Attack Severity Over Time</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="attackSeverityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Time Analysis Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Response Time Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Most Used Destination Ports Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Most Used Destination Ports</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="mostUsedPortsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Content Row -->
    <div class="row">
        <!-- Correlation Matrix of Attack Types -->
        <div class="col-xl-12 col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Correlation Matrix of Attack Types</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="correlationMatrixChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script>
    $(document).ready(function() {
    function updateGraphs() {
        var startDate = $('#start_date').val();
        var endDate = $('#end_date').val();

        $.ajax({
            url: "{% url 'real_time_network_traffic_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                console.log(data); // Log the data to verify
                var ctx = document.getElementById("networkTrafficChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.times,
                        datasets: [{
                            label: "Total Packet Length per Minute",
                            data: data.lengths,
                            backgroundColor: "rgba(78, 115, 223, 0.05)",
                            borderColor: "rgba(78, 115, 223, 1)",
                            fill: false
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            xAxes: [{
                                time: {
                                    unit: 'hour'
                                },
                                gridLines: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }],
                            yAxes: [{
                                ticks: {
                                    maxTicksLimit: 5,
                                    padding: 10
                                },
                                gridLines: {
                                    color: "rgb(234, 236, 244)",
                                    zeroLineColor: "rgb(234, 236, 244)",
                                    drawBorder: false,
                                    borderDash: [2],
                                    zeroLineBorderDash: [2]
                                }
                            }]
                        },
                        legend: {
                            display: false
                        }
                    }
                });
            },
            error: function(error) {
                console.log(error); // Log error if there's an issue
            }
        });

        $.ajax({
            url: "{% url 'top_talkers_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("topTalkersChart").getContext("2d");
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.src_ips,
                        datasets: [{
                            label: "Packet Count",
                            data: data.counts,
                            backgroundColor: "rgba(54, 162, 235, 0.6)",
                            borderColor: "rgba(54, 162, 235, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'top_listeners_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("topListenersChart").getContext("2d");
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dst_ips,
                        datasets: [{
                            label: "Packet Count",
                            data: data.counts,
                            backgroundColor: "rgba(75, 192, 192, 0.6)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'attack_trends_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var colors = {
                    "DDOS attack-HOIC": "rgba(255, 99, 132, 0.6)",
                    "DDOS attack-LOIC-UDP": "rgba(54, 162, 235, 0.6)",
                    "FTP-BruteForce": "rgba(255, 206, 86, 0.6)",
                    "Brute Force -Web": "rgba(75, 192, 192, 0.6)",
                    "Brute Force -XSS": "rgba(153, 102, 255, 0.6)",
                    "SQL Injection": "rgba(255, 159, 64, 0.6)",
                    "Benign": "rgba(99, 255, 132, 0.6)"
                };

                var ctx = document.getElementById("attackTrendsChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.times,
                        datasets: data.attack_trends.map((trend, index) => ({
                            label: trend.label,
                            data: trend.data,
                            backgroundColor: colors[trend.label],
                            borderColor: colors[trend.label],
                            fill: false
                        }))
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            xAxes: [{
                                time: {
                                    unit: 'minute'
                                },
                                gridLines: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }],
                            yAxes: [{
                                ticks: {
                                    maxTicksLimit: 5,
                                    padding: 10
                                },
                                gridLines: {
                                    color: "rgb(234, 236, 244)",
                                    zeroLineColor: "rgb(234, 236, 244)",
                                    drawBorder: false,
                                    borderDash: [2],
                                    zeroLineBorderDash: [2]
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'protocol_usage_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("protocolUsageChart").getContext("2d");
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.protocols,
                        datasets: [{
                            data: data.usage,
                            backgroundColor: data.colors,
                            hoverBackgroundColor: data.hoverColors,
                            hoverBorderColor: "rgba(234, 236, 244, 1)",
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            backgroundColor: "rgb(255,255,255)",
                            bodyFontColor: "#858796",
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: false,
                            caretPadding: 10,
                        },
                        legend: {
                            display: true
                        },
                        cutoutPercentage: 80,
                    },
                });
            }
        });

        $.ajax({
            url: "{% url 'attack_severity_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("attackSeverityChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.times,
                        datasets: [{
                            label: "Attack Severity",
                            data: data.severity,
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            fill: false
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            xAxes: [{
                                time: {
                                    unit: 'minute'
                                },
                                gridLines: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }],
                            yAxes: [{
                                ticks: {
                                    maxTicksLimit: 5,
                                    padding: 10
                                },
                                gridLines: {
                                    color: "rgb(234, 236, 244)",
                                    zeroLineColor: "rgb(234, 236, 244)",
                                    drawBorder: false,
                                    borderDash: [2],
                                    zeroLineBorderDash: [2]
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'response_time_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("responseTimeChart").getContext("2d");
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.incidents,
                        datasets: [{
                            label: "Response Time (s)",
                            data: data.response_times,
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'correlation_matrix_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("correlationMatrixChart").getContext("2d");
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.attack_types,
                        datasets: data.correlation.map((correlation, index) => ({
                            label: data.attack_types[index],
                            data: correlation,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }))
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });

        $.ajax({
            url: "{% url 'most_used_ports_data' %}",
            method: "GET",
            data: { start_date: startDate, end_date: endDate },
            success: function(data) {
                var ctx = document.getElementById("mostUsedPortsChart").getContext("2d");
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.ports,
                        datasets: [{
                            label: "Packet Count",
                            data: data.counts,
                            backgroundColor: "rgba(78, 115, 223, 0.7)",
                            borderColor: "rgba(78, 115, 223, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        },
                        legend: {
                            display: true
                        }
                    }
                });
            }
        });
    }

    $('#start_date, #end_date').change(function() {
        updateGraphs();
    });

    updateGraphs();
    setInterval(updateGraphs, 5000); // Update every 5 seconds
    });

</script>

{% endblock %}
